---
title: "Chen_Joanna_RPROJECT"
author: "Joanna Chen"
date: "11/12/2019"
output: html_document
---

#GRADE: 90/100

YOUR REPORT IS REALLY BEAUTIFUL AND WELL DONE

(-10) YOUR CALCULATIONS OF SEVERAL OF THE VARIABLES ARE NOT QUITE RIGHT.
YOU HAVE TOO FEW WITH A1 (AND THIS IMPACTS THE CALCULATION OF WE - WHICH IS ALSO NOT QUITE CORRECT)
AND TOO MANY WITH DISEASE X 
THINGS NEEDED TO BE CALCULATED BY UNIQUE ID AND NOT BY SITEID - THE SITEID IS NOT UNIQUE (ONLY WITHIN SITE)

```{r setup, include=FALSE}
#The file takes 12.43 seconds to knit. 
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="~/Downloads/Data for R Project")
#knitr::opts_knit$set(root.dir="R:/Teaching/Programming 2019/R Project/RProject Data")
```

```{r, include = FALSE}
# Check if the package will be used in this file has been installed. If not, install it.
if(!require("data.table")){
  install.packages("data.table",repos = "http://cran.us.r-project.org")
}
library(data.table)

if(!require("ggplot2")){
  install.packages("ggplot2",repos = "http://cran.us.r-project.org")
}
library(ggplot2)

if(!require("scales")){
  install.packages("scales",repos = "http://cran.us.r-project.org")
}
library(scales)

```

```{r, include = FALSE}
# Read in the data sets
CohortCrosswalk = read.csv("CohortCrosswalk.csv", header=TRUE)
IDiagnosisCrosswalk = read.csv("IDiagnosisCrosswalk.csv", header=TRUE)
InpatientVisits = read.csv("InpatientVisits.csv", header=TRUE)
LabCrosswalk = read.csv("LabCrosswalk.csv", header=TRUE)
MainPatientFile = read.csv("MainPatientFile.csv", header=TRUE)
MedicationCrosswalk = read.csv("MedicationCrosswalk.csv", header=TRUE)
Medications = read.csv("Medications.csv", header=TRUE)
ODiagnosisCrosswalk = read.csv("ODiagnosisCrosswalk.csv", header=TRUE)
OutpatientLabs = read.csv("OutpatientLabs.csv", header=TRUE)
OutpatientVisits = read.csv("OutpatientVisits.csv", header=TRUE)

# Set in the data.table format on all datasets at once. Credit to 
# https://stackoverflow.com/questions/55085433/can-we-setdt-on-multiple-object-all-at-once
all_data_tables = Filter(function(x) is.data.frame(eval(as.name(x))), ls())
lapply(all_data_tables, function(x) setDT(eval(as.name(x))))
```

```{r, include = FALSE}
# Add uniqueID to the MainPatientFile by joining with MainPatientFile based on the common column siteID and SiteNo
setkeyv(CohortCrosswalk,c("siteID","SiteNo"))
setkeyv(MainPatientFile,c("siteID","SiteNo"))
MainPatientFile = CohortCrosswalk[MainPatientFile]

# Create birth_date and record_date columns based on month_birth, day_birth, year_birth columns, and format it.
MainPatientFile$birth_date = format(as.Date(with(MainPatientFile, paste(month_birth, day_birth, year_birth,sep="/")), "%m/%d/%Y"),'%m/%d/%Y')
MainPatientFile$record_date = format(as.Date(with(MainPatientFile, paste(record_month, record_day, record_year,sep="/")), "%m/%d/%Y"),'%m/%d/%Y')
```

```{r, include = FALSE}
# Calculate the age based on date record last updated
MainPatientFile$age = round(as.numeric(as.Date(MainPatientFile$record_date,format = "%m/%d/%Y") - as.Date(MainPatientFile$birth_date,format = "%m/%d/%Y")) / 365.25,2)

# Categorize the age as younger (<50) and older (>=50)
MainPatientFile[,Agecat:= ifelse(age>=50,"Older","Younger")]

# Remove the columns we don't need
MainPatientFile[,c("month_birth","day_birth","year_birth","record_month","record_day","record_year"):=NULL]
```

```{r, include = FALSE}
# Add the diagnosis name to the InpatientVisits by joining with IDiagnosisCrosswalk based on the diagnosis code
setkey(InpatientVisits,diagnosis_code)
setkey(IDiagnosisCrosswalk,Diagnosis_code)
InpatientVisits = InpatientVisits[IDiagnosisCrosswalk]

setkey(OutpatientVisits,diagnosis_code)
setkey(ODiagnosisCrosswalk,Diagnosis_code)
OutpatientVisits = OutpatientVisits[ODiagnosisCrosswalk]

# Format the visidate in the OutpatientVisits file, admitdate and dischargedate in the InpatientVisits file
OutpatientVisits$visitdate_formatted = as.Date(OutpatientVisits$visitdate, origin = "1960-01-01")
InpatientVisits$admitdate_formatted = as.Date(InpatientVisits$admitdate, origin = "1960-01-01")
InpatientVisits$dischargedate_formatted = as.Date(InpatientVisits$dischargedate, origin = "1960-01-01")
```

```{r, include = FALSE}
# Determine whether an individual has chronic condition A1 prior to 2015 and assign the corresponding indicator. If it has, then the following three conditions should be satisfied.
# 1. have chronic condition A1.1 through A1.6
# 2. Prior to 2015. checking using visitdate for outpatient, use admitdate for inpatient
chronic_inpat = InpatientVisits[Diagnosis %in% c("A1","A1.1","A1.2","A1.3","A1.4","A1.5","A1.6")]
chronic_inpat = chronic_inpat[admitdate_formatted-as.Date("2015-01-01",format = "%Y-%m-%d")<0]

chronic_outpat = OutpatientVisits[Diagnosis %in% c("A1","A1.1","A1.2","A1.3","A1.4","A1.5","A1.6")]
chronic_outpat = chronic_outpat[visitdate_formatted-as.Date("2015-01-01",format = "%Y-%m-%d")<0]
# 3. chronic: one must have (1) at least two independent outpatient diagnoses (separate dates) of the condition AND (2) at least one inpatient diagnosis of the condition.
# To check (1), we extract the siteID with at least two independent outpatient diagnoses (separate dates) of the condition
chronic_outpat = chronic_outpat[,N:=.N,by=siteID]
chronic_outpat = chronic_outpat[N>=2]

# Check separate date. 
# chronic_outpat[, .N, by = c("siteID","visitdate")]
# Each cell in the N column equals 1. We know for each of the filtered chronic outpatient, everytime they have the diagnoses,the visit date is different. Therefore, we can concluded their outpatient diagnoses are all independent .

# Then we take the intersection the siteID satisfies (1) and (2) and save the unique siteID in a vector
chronic_patID = as.vector(unique(intersect(chronic_inpat$siteID,chronic_outpat$siteID)))

# For all patients, if his/her id in the vector, set the A1 indicator as 1, otherwise 0
MainPatientFile[, A1:=ifelse(siteID %in% chronic_patID,1,0)]
```

```{r, include = FALSE}
# Add the lab name to the OutpatientLabs by joining with LabCrosswalk based on the lab code
setkey(OutpatientLabs,lab_code)
setkey(LabCrosswalk,lab_code)
OutpatientLabs=OutpatientLabs[LabCrosswalk]

# Format the lab date and create the most recent date column
OutpatientLabs$labdate_formatted = as.Date(OutpatientLabs$labdate, origin = "1960-01-01")
OutpatientLabs = OutpatientLabs[,recent_labdate := max(as.Date(labdate_formatted, '%m-%d-%Y')),siteID]

# Determine whether an individual has been diagnosed with disease X and assign the corresponding indicator
#An individual will be classified as having disease X if (1) their last result of PPP (lab name) is positive OR (2) they have ever had a KOPD (lab name) value greater than 2.

# Extract the siteID of the patient who satisfies (1) or (2) and put the unique extracted siteID in the same vector 
diseaseX_patID=unique(c(OutpatientLabs[LabName == "PPP" & labdate_formatted==recent_labdate& qual_results == "Positive"]$siteID, OutpatientLabs[LabName == "KOPD"][as.numeric(as.character(qual_results)) > 2]$siteID))

# For all patients, if his/her id in the vector, set the diseaseX indicator as 1, otherwise 0
MainPatientFile[,diseaseX:=ifelse(siteID %in% diseaseX_patID,1,0)]
# This automatically considers that if there are conflicting results for a given day, Positive trumps Negative and greater than 2 trumps <= 2, which the instruction asks for.
```

```{r, include = FALSE}
# Determine whether receipt of prescription WE any time during 2015 and 2016 for those with chronic condition A1 prior to 2015 (A1 created above)
# Add the medication name to the Medications by joining with MedicationCrosswalk based on the medication code
setkey(Medications,medication_code)
setkey(MedicationCrosswalk,medication_code)
Medications = Medications[MedicationCrosswalk]

#Format the PrescriptionDate in the Medications file.
Medications$PrescriptionDate_formatted = as.Date(Medications$PrescriptionDate, origin = "1960-01-01")

# Filter the data, store the unique siteID such that its WE prescription date is during 2015 and 2016 in the vector WE_id
WE_dt = Medications[PrescriptionDate_formatted-as.Date("2015-01-01",format = "%Y-%m-%d")>=0 & PrescriptionDate_formatted-as.Date("2017-01-01",format = "%Y-%m-%d")<0 & Medication.Name=="WE"]
WE_id = unique(WE_dt$siteID)

# For all patients, if his/her id in the vector in the WE_id, set the WE_15_16 indicator as 1, otherwise 0. If the patient received prescription WE any time during 2015 and 2016, and with chronic condition A1 prior to 2015, then set the WE indicator as 1, otherwise 0.
MainPatientFile[,WE_15_16:=ifelse(siteID %in% WE_id,1,0)]
MainPatientFile[,WE:=ifelse(A1==1 & WE_15_16==1,1,0)]

```

```{r, include = FALSE}
# Create an indicator of receipt of WE longer than 6 months
# Note that WE_dt is the filtered data set with rows with the medication information of patient received prescription WE any time during 2015 and 2016. On the WE_dt, we total compute every one's total coverage. 
WE_dt = WE_dt[,coverage:=sum(Refills * dayssupply),siteID]

# We store the siteID of patient whose WE is greater than 180 during 2015 and 2016 which is considered as chronic in the vector chronic_WE_id.
WE_dt = WE_dt[,chronicWE:=ifelse(coverage>180,1,0)][chronicWE==1]
chronic_WE_id = unique(WE_dt$siteID)

# For all patients, if his/her id in the vector in the chronic_WE_id, set the chronicWE indicator as 1, otherwise 0.
MainPatientFile[,chronicWE:=ifelse(siteID %in% chronic_WE_id,1,0)]
```

```{r, include = FALSE}
# Label the categorical variable
MainPatientFile$SiteNo <- factor(MainPatientFile$SiteNo, levels = c(1:30), labels = c("NY","NJ","CT","ME", "CA","NH","DE","VA","NC","SC","GA","FL","WV","WA","OR","NM","MI","MA","ND","SD","MD","VT","WY","PA","OH","OK","TX","NV","UT","LA"))
MainPatientFile$sex <- factor(MainPatientFile$sex, levels = c(0:1), labels = c("Female","Male" ))
MainPatientFile$race <- factor(MainPatientFile$race, levels = c(0:5), labels = c("White","Black", "Asian", "Native American", "Pacific Islander","Unknown"))
MainPatientFile$marital_status <- factor(MainPatientFile$marital_status, levels = c(1:6), labels = c("Married","Divorced", "Separated", "Widowed", "Single","Other"))
MainPatientFile$income_bracket <- factor(MainPatientFile$income_bracket, levels = c(1:7), labels = c("<20,000","20,000 to <40,000", "40,000 to <80,000", "80,000 to 120,000", "> 120,000","Refuse to Respond","Missing"))

MainPatientFile$A1 <- factor(MainPatientFile$A1, levels = c(0:1), labels = c("No","Yes"))
MainPatientFile$diseaseX <- factor(MainPatientFile$diseaseX, levels = c(0:1), labels = c("No","Yes"))
MainPatientFile$WE <- factor(MainPatientFile$WE, levels = c(0:1), labels = c("No","Yes"))
MainPatientFile$chronicWE <- factor(MainPatientFile$chronicWE, levels = c(0:1), labels = c("No","Yes"))

```

```{r, include = FALSE}
# Sort UniqueID by ascending order
MainPatientFile[order(MainPatientFile$UniqueID),]  
# Remove the non-used column
MainPatientFile[,c("WE_15_16","siteID","SiteNo"):=NULL]

# Since individuals may visit more than one site for care within this healthcare system, we want the individual demographics to be defined based on the last site visited (most recently updated record) for an individual on the processed dataset.
FINALDATA = MainPatientFile[order(-as.Date(record_date, '%m/%d/%Y')), head(.SD, 1), by = uniqueID]
FINALDATA[,record_date:=NULL]
```

The main objective of this project is to prepare the preliminary data for the researcher I'm working with who is interested in writing a grant. This report summarises the work performed, specifically 
extracting data from several relational databases and summarizing them.

# Data description
In this project, I've worked with the following data sets.\par
1. MainPatientFile.csv: Contains demographic information for the cohort.
\par
2. CohortCrosswalk.csv: This contains the file that links the siteID with uniqueID.\par
3. OutpatientVisits.csv: Contains information about outpatient visits.\par
4. InpatientVisits.csv: Contains information about hospitalizations. \par
5. ODiagnosisCrosswalk.csv: Contain the linkage between the diagnosis code and the diagnosis for
outpatient visits.\par
6. IDiagnosisCrosswalk.csv: Contain the linkage between the diagnosis code and the diagnosis for
inpatient visits. \par
7. OutpatientLabs.csv: Contains the information on lab tests. \par
code.\par
9. Medications.csv: Contains information on drug prescriptions.\par
10. MedicationCrosswalk.csv: Contains linkage between medication code and medication name.\par

# Data Cleaning
In this part, I extract and integrate information from different datasets and convert poorly structured data into structured data. The work was done by R version 3.6.1 using data.table package. Specifically, I categorize patients' age, created several indicator related to patients' certain chronic disease, medication prescription, etc, and generate a final dataset. The final dataset includes 5871 observations and 12 variables, which contains one row of data per individual. In the final dataset, the individual demographics is defined based on the last site visited (most recently updated record) for an individual.
\par
Here's the the first 5 and last 5 observations of the final dataset sorting by the ascending order of uniqueID.
```{r,echo=FALSE}
first_five=head(FINALDATA[order(uniqueID)],5)
last_five = tail(FINALDATA[order(uniqueID)],5)

knitr::kable(first_five)
knitr::kable(last_five)
```

# Results and Discussion
Table 1 summarizes the relative frequency distribution for each categorical variable. In our data, we found that the majority of the patients in our record are male (95.11%) comparing with female (4.89%). The number of White patients are the most (42.48%), and follwed by Black (26.06%), Unknown (14.56%), Pacific Islander (5.81%), Asian (5.67%) and Native American (5.42%). The number of married patients are the most (41.75%), followed by Divorced (19.89%), Widowed (10.94%), Single (10.92%), Separated (10.41%) and Other (6.10%). Almost half of the total patients income range are in the range of less than 20,000 (24.58%) and 20,000-40,000 (24.29%). It follows by people whose income fall into 40,000-80,000 (14.70%), 80,000-120,000(10.27%) and over 120,000 (5.552%). Note that there are 10.65% of patients refused to respond and there are 10.00% of missing data. 

```{r,echo=FALSE}
table1 = c("**Sex distribution**", n = "",Percent = "")
#table1 = rbind(table1, c("Sex distribution", "" ,""))
table1 = rbind(table1, c("Male",n = FINALDATA[,.N,sex][sex == "Male"]$N ,Percent = percent(FINALDATA[,.N,sex][sex == "Male"]$N/sum(FINALDATA[,.N,sex]$N),accuracy = 0.01)))
table1 = rbind(table1, c("Female",n = FINALDATA[,.N,sex][sex == "Female"]$N ,Percent = percent(FINALDATA[,.N,sex][sex == "Female"]$N/sum(FINALDATA[,.N,sex]$N),accuracy = 0.01)))

table1 = rbind(table1, c("**Race distribution**", "" ,""))
for (i in 1:nrow(FINALDATA[,.N,race])) {
    table1 = rbind(table1, c(as.character(FINALDATA[,.N,race][order(-N)]$race[i]),n = FINALDATA[,.N,race][order(-N)]$N[i] ,Percent = percent(FINALDATA[,.N,race][order(-N)]$N[i]/sum(FINALDATA[,.N,race][order(-N)]$N),accuracy = 0.01)))
}

table1 = rbind(table1, c("**Marital Status distribution**", "" ,""))
for (i in 1:nrow(FINALDATA[,.N,marital_status])) {
    table1 = rbind(table1, c(as.character(FINALDATA[,.N,marital_status][order(-N)]$marital_status[i]),n = FINALDATA[,.N,marital_status][order(-N)]$N[i] ,Percent = percent(FINALDATA[,.N,marital_status][order(-N)]$N[i]/sum(FINALDATA[,.N,marital_status][order(-N)]$N),accuracy = 0.01)))
}

table1 = rbind(table1, c("**Income distribution**", "" ,""))
for (i in 1:nrow(FINALDATA[,.N,income_bracket])) {
    table1 = rbind(table1, c(as.character(FINALDATA[,.N,income_bracket][order(-N)]$income_bracket[i]),n = FINALDATA[,.N,income_bracket][order(-N)]$N[i] ,Percent = percent(FINALDATA[,.N,income_bracket][order(-N)]$N[i]/sum(FINALDATA[,.N,marital_status][order(-N)]$N),accuracy = 0.01)))
}

rownames(table1)=NULL

knitr::kable(table1,longtable = T,align = "c", caption = "Table 1. Summary of patient characteristics")
```


```{r,echo=FALSE,fig.cap="Figure 1. Histogram of Patient Age Distribution",fig.align="center"}
#hist(FINALDATA$age)
age_plot <- ggplot(FINALDATA, aes(x = age)) +
        geom_histogram(aes(y = ..density..),binwidth = 2,colour = "#3366FF",fill = "#33CCFF") +
        scale_x_continuous(name = "Patient Age in Years") +
        scale_y_continuous(name = "Count") + theme(plot.subtitle = element_text(vjust = 1), 
    plot.caption = element_text(vjust = 1), 
    panel.grid.major = element_line(colour = "gray94"), 
    panel.background = element_rect(fill = "gray98"))
age_plot
```
\par
The age histogram has been shown in Figure 1. The minimum patient age is 15.44, maximum is 91.82, median is 56.35, mean is 56.18, first quantile is 41.83 and the third quantile is 70.74.
\par
Our investigator are specifically interested in chronic condition A1, disease X, and medication WE. We found that the proportion of individuals in the cohort had chronic condition A1 prior to 2015 is 15.64%. We categorize the age into younger (<50) and older (>=50) and found that the age distribution of chronic condition A1 in this population is 61.87% for older and 38.13% for older. The proportion of individuals have disease X is 38%, including 62% of male and 38% of female. The proportion of individuals classified as having chronic condition A1 prior to 2015, received a prescription for WE during the 2015 and 2016 calendar years is 3.32%. The breakdown by race of individuals classified as having chronic condition A1 prior to 2015 and received a prescription for WE during the 2015 and 2016 calendar years are - 82 White, 51 Black, 11 Asian, 10 Native American, 8 Pacific Islander and 33 Unknown. The proportion of individuals classified as having chronic condition A1 prior to 2015 receiving a prescription for WE during the 2015 and 2016 calendar years would be covered longer than 6-month over this time frame is 25.13%. The detailed table has been included in the appendix section.

# Acknowledgement
I would like thank Professor Denise Esserman for her guidance and help answering the questions in this project.

# Appendix
The investigator are specifically interested in the following questions.

\par A. What is the demographic breakdown of the population (e.g. a table with the relative frequency distribution for each variable; histogram for continuous variables)?
\par Please see Table 1 and Figure 1. 

B. What proportion of individuals in the cohort had chronic condition A1 prior to 2015?
```{r,echo=FALSE}
A1_prop = setDT(as.data.frame(percent(FINALDATA[,.N,A1][A1=="Yes"]$N/sum(FINALDATA[,.N,A1]$N),accuracy = 0.01)))
setnames(A1_prop,"percent(FINALDATA[, .N, A1][A1 == \"Yes\"]$N/sum(FINALDATA[, .N, A1]$N), accuracy = 0.01)","A1 Proportion")
knitr::kable(A1_prop)
```
C. What is the age distribution of chronic condition A1 in this population, using younger (<50)
and older (>=50)?
```{r,echo=FALSE}
filter_A1 = FINALDATA[A1=="Yes"]
age_category_distr_of_A1 = filter_A1[,.N,Agecat][,proportion := percent(N/sum(N),accuracy = 0.01)]
knitr::kable(age_category_distr_of_A1,width = "3cm",align = "c")
#table(FINALDATA$Agecat,FINALDATA$A1)

#age_cat_A1_plot <- ggplot(filter_A1, aes(x = age)) + geom_histogram(aes(y = ..density..,color = Agecat, fill = Agecat), alpha = 0.4, position = "identity") + scale_fill_manual(values = c("#00AFBB", "#E7B800")) + scale_color_manual(values = c("#00AFBB", "#E7B800"))
#age_cat_A1_plot

#ROUND 2
```

D. What proportion of individuals have disease X?
```{r,echo=FALSE}
diseaseX_prop = FINALDATA[,.N,diseaseX][,prop := percent(N/sum(N),accuracy = 0.01)]
knitr::kable(diseaseX_prop,width = "3cm",align = "c")
```

E. What is the gender distribution of disease X in the population?
```{r,echo=FALSE}
filtered_diseaseX = FINALDATA[diseaseX=="Yes"]
gender_distr_of_X = filtered_diseaseX[,.N,sex][,prop := percent(N/sum(N),accuracy = 0.01)]
knitr::kable(gender_distr_of_X,width = "3cm",align = "c")
#table(FINALDATA$diseaseX,FINALDATA$sex)


#ggplot(filtered_diseaseX, aes(x = sex, y = ..density..)) + geom_bar(fill = "#0073C2FF", stat = "identity") + geom_text(aes(label = ..density..), vjust = -0.3)

```

F. What proportion of individuals classified as having chronic condition A1 prior to 2015,
received a prescription for WE (medication name) during the 2015 and 2016 calendar years?
```{r,echo=FALSE}
WE_prop = FINALDATA[,.N,WE][,prop := percent(N/sum(N),accuracy = 0.01)][WE=="Yes"]
knitr::kable(WE_prop,width = "3cm",align = "c")
```

G. What is the breakdown by race of individuals classified as having chronic condition A1 prior to 2015 and received a prescription for WE (medication name) during the 2015 and 2016 calendar years?
```{r,echo=FALSE}
prop_race_WE=setDT(as.data.frame(table(FINALDATA$WE,FINALDATA$race)))[Var1=="Yes"][,-1]
setnames(prop_race_WE,"Var2","Race")
knitr::kable(prop_race_WE,align = "c")
```

H. What proportion of individuals classified as having chronic condition A1 prior to 2015 receiving a prescription for WE (medication name) during the 2015 and 2016 calendar years would be covered longer than 6-month over this time frame?
```{r,echo=FALSE}
prop_chronicWE_WE = setDT(as.data.frame(FINALDATA[,.N,c("WE","chronicWE")][WE=="Yes"][,prop := percent(N/sum(N),accuracy = 0.01)][chronicWE=="Yes"]))[,-c(1,2)]

knitr::kable(prop_chronicWE_WE,align = "c")
```

